# .github/workflows/ci-and-release.yml
name: CI & Release

permissions:
  contents: write
  packages: write

on:
  push:
    branches: [ "main" ]
    tags: [ "v*.*.*" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always
  IMAGE_NAME: treetop-rest
  GHCR_REGISTRY: ghcr.io/${{ github.repository_owner }}/treetop-rest
  DOCKERHUB_REGISTRY: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/treetop-rest

jobs:
  build:
    name: Build - Test - Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo registry/index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Cache Cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose
      - name: Run clippy
        run: cargo clippy --verbose

  publish-develop:
    name: Publish “develop” image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      # 1) Login to both registries
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 2) Build & tag as develop
      - name: Build & push “develop” image
        run: |
          docker build \
            --file Dockerfile \
            --build-arg GIT_BRANCH=${{ github.ref_name }} \
            --build-arg GIT_SHA=${{ github.sha }} \
            --build-arg GIT_DESCRIBE=$(git describe --tags --always --dirty) \
            --tag $GHCR_REGISTRY:develop \
            --tag $DOCKERHUB_REGISTRY:develop \
            .
          docker push $GHCR_REGISTRY:develop
          docker push $DOCKERHUB_REGISTRY:develop

  publish-release:
    name: "Release: container + binaries"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    env:
      TAG: ${{ github.ref_name }}      # e.g. “v1.2.3”
    steps:
      - uses: actions/checkout@v4

      # A) Login to registries
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # B) Build & push server container under both $TAG and “latest”
      - name: Build & push server images
        run: |
          for REG in $GHCR_REGISTRY $DOCKERHUB_REGISTRY; do
            docker build \
              --file Dockerfile \
              --build-arg GIT_BRANCH=${{ github.ref_name }} \
              --build-arg GIT_SHA=${{ github.sha }} \
              --build-arg GIT_DESCRIBE=$(git describe --tags --always --dirty) \
              --tag $REG:${{ env.TAG }} \
              --tag $REG:latest \
              .
            docker push $REG:${{ env.TAG }}
            docker push $REG:latest
          done

      # C) Cross-compile server & cli for Linux x86_64 + ARM (musl)
      - name: Install cross-compilation tool
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Build native binaries
        run: |
          cross build --release --target x86_64-unknown-linux-musl
          cross build --release --target aarch64-unknown-linux-musl

      - name: Package artifacts
        run: |
          mkdir release-artifacts
          for TGT in x86_64 aarch64; do
            BIN_X=target/${TGT}-unknown-linux-musl/release
            tar czf release-artifacts/treetop-server-${TGT}-linux-musl.tar.gz -C $BIN_X treetop-server
            tar czf release-artifacts/treetop-cli-${TGT}-linux-musl.tar.gz -C $BIN_X treetop-cli
          done

      # D) Create GH Release & upload binaries
      - name: Create GitHub Release & upload binaries
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          artifacts: |
            release-artifacts/treetop-server-x86_64-linux-musl.tar.gz
            release-artifacts/treetop-server-aarch64-linux-musl.tar.gz
            release-artifacts/treetop-cli-x86_64-linux-musl.tar.gz
            release-artifacts/treetop-cli-aarch64-linux-musl.tar.gz

